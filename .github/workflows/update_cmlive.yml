name: è‡ªåŠ¨æ£€æµ‹å¹¶æ›´æ–°ç›´æ’­æºï¼ˆ6å°æ—¶ï¼‰

on:
  schedule:
    # æ¯6å°æ—¶æ£€æµ‹ä¸€æ¬¡ï¼ˆUTC = åŒ—äº¬æ—¶é—´ - 8ï¼‰
    # å³åŒ—äº¬æ—¶é—´ 00:00ã€06:00ã€12:00ã€18:00
    - cron: '0 */6 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  check_and_update:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4

      - name: è·å–å½“å‰åŒ—äº¬æ—¶é—´
        id: time
        run: |
          now=$(date -u -d '+8 hour' '+%Y-%m-%d %H:%M')
          echo "ğŸ•’ å½“å‰åŒ—äº¬æ—¶é—´: $now"
          echo "current_time=$now" >> $GITHUB_OUTPUT

      - name: æ£€æµ‹ç›´æ’­æºæ¥å£æ˜¯å¦æ›´æ–°
        id: check
        run: |
          url="https://raw.githubusercontent.com/q1017673817/iptvz/refs/heads/main/zubo_all.txt"
          echo "ğŸ“¡ æ­£åœ¨æ£€æµ‹ç›´æ’­æºæ¥å£å˜åŒ–..."
          curl -sL "$url" -o source.txt || { echo "âŒ ä¸‹è½½æ¥å£å¤±è´¥"; exit 1; }

          md5=$(md5sum source.txt | cut -d ' ' -f1)
          echo "æ¥å£å½“å‰å“ˆå¸Œ: $md5"

          old_hash=$(cat last_hash.txt 2>/dev/null || echo "")
          if [ "$old_hash" = "$md5" ]; then
            echo "ğŸŸ¢ æ¥å£æœªå˜åŒ–ï¼Œè·³è¿‡æ›´æ–°"
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ æ£€æµ‹åˆ°æ¥å£å†…å®¹å˜åŒ–"
            echo "$md5" > last_hash.txt
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: è®¾ç½® Python ç¯å¢ƒ
        if: steps.check.outputs.changed == 'true'
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: å®‰è£…ä¾èµ–
        if: steps.check.outputs.changed == 'true'
        run: |
          pip install --upgrade pip
          pip install aiohttp requests

      - name: æ‰§è¡Œæµ‹é€Ÿæ›´æ–°è„šæœ¬
        if: steps.check.outputs.changed == 'true'
        run: |
          echo "ğŸš€ æ£€æµ‹åˆ°æ¥å£å˜åŒ–ï¼Œæ‰§è¡Œ update_live.py ..."
          python update_live.py || { echo "âŒ è„šæœ¬æ‰§è¡Œå¤±è´¥"; exit 1; }

      - name: æ£€æŸ¥ç”Ÿæˆæ–‡ä»¶
        if: steps.check.outputs.changed == 'true'
        run: |
          echo "ğŸ“ å½“å‰ç›®å½•æ–‡ä»¶ï¼š"
          ls -la
          echo ""
          echo "ğŸ“œ cmlive.txt å†…å®¹é¢„è§ˆï¼š"
          head -n 20 cmlive.txt || echo "âš ï¸ æ–‡ä»¶æœªç”Ÿæˆ"

      - name: æäº¤æ›´æ–°
        if: steps.check.outputs.changed == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add cmlive.txt last_hash.txt
          if git diff --cached --quiet; then
            echo "ğŸŸ¢ æ— éœ€æäº¤"
          else
            git commit -m "ğŸ“º è‡ªåŠ¨æ›´æ–° cmlive.txtï¼ˆæ¥å£å˜åŒ–è§¦å‘ï¼‰$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"
            git push
          fi

      - name: æ— å˜åŒ–æ—¶æç¤º
        if: steps.check.outputs.changed != 'true'
        run: |
          echo "âœ… æ²¡æœ‰æ£€æµ‹åˆ°æ¥å£å˜åŒ–ï¼Œä»»åŠ¡ç»“æŸã€‚"
